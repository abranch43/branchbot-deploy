name: Gumroad Sync + Social PR (v3)

on:
  workflow_dispatch:
  push:
    paths:
      - 'ops/gumroad-agent/config/gumroad.config.yaml'
      - 'ops/gumroad-agent/agents/gumroad_sync.py'
      - 'ops/gumroad-agent/scripts/social_post_out.py'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install requests PyYAML playwright

      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps

      - name: Run Gumroad Sync
        env:
          GUMROAD_ACCESS_TOKEN: ${{ secrets.GUMROAD_ACCESS_TOKEN }}
          GUMROAD_EMAIL: ${{ secrets.GUMROAD_EMAIL }}
          GUMROAD_PASSWORD: ${{ secrets.GUMROAD_PASSWORD }}
        run: |
          python ops/gumroad-agent/agents/gumroad_sync.py --config ops/gumroad-agent/config/gumroad.config.yaml

      - name: Render social copy
        run: |
          python ops/gumroad-agent/scripts/social_post_out.py
          ls -la rendered_social || true

      - name: Create branch for social artifacts
        run: |
          BRANCH="automation/gumroad-social-${{ github.run_id }}"
          git checkout -b "$BRANCH"
          mkdir -p rendered_social
          git add rendered_social/*
          git -c user.name='github-actions[bot]' -c user.email='41898282+github-actions[bot]@users.noreply.github.com' commit -m "chore: add rendered social copy from sync run ${{ github.run_id }}"
          git push --set-upstream origin "$BRANCH"

      - name: Open PR with rendered posts
        uses: actions/github-script@v7
        with:
          script: |
            const runId = process.env.GITHUB_RUN_ID;
            const branch = `automation/gumroad-social-${runId}`;
            const { repo, owner } = context.repo;
            const title = `Rendered social copy from Gumroad Sync (${runId})`;
            const body = [
              "This PR adds ready-to-paste pinned posts:",
              "- `rendered_social/x_pin.txt`",
              "- `rendered_social/linkedin_pin.txt`",
              "",
              "Review the links and pin them on X & LinkedIn."
            ].join("\\n");
            await github.rest.pulls.create({
              owner, repo,
              title,
              head: branch,
              base: "main",
              body
            });
