name: Gumroad Sync + Social PR (v3.2)

on:
  workflow_dispatch: {}   # manual only

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install requests PyYAML playwright || true

      - name: Install Playwright browsers (best-effort)
        run: |
          python -m playwright install --with-deps || true

      - name: Run Gumroad Sync (never fail pipeline)
        env:
          GUMROAD_ACCESS_TOKEN: ${{ secrets.GUMROAD_ACCESS_TOKEN }}
          GUMROAD_EMAIL: ${{ secrets.GUMROAD_EMAIL }}
          GUMROAD_PASSWORD: ${{ secrets.GUMROAD_PASSWORD }}
        run: |
          set -euxo pipefail
          python ops/gumroad-agent/agents/gumroad_sync.py --config ops/gumroad-agent/config/gumroad.config.yaml || true

      # Write artifacts into a non-ignored folder: .auto/social/*
      - name: Render social copy (always succeeds)
        run: |
          set -euo pipefail
          python ops/gumroad-agent/scripts/social_post_out.py || true
          mkdir -p .auto/social
          # copy if generated
          [ -f rendered_social/x_pin.txt ] && cp rendered_social/x_pin.txt .auto/social/x_pin.txt || true
          [ -f rendered_social/linkedin_pin.txt ] && cp rendered_social/linkedin_pin.txt .auto/social/linkedin_pin.txt || true
          # ensure files if script short-circuited (single-quoted heredocs avoid $ expansion)
          [ -f .auto/social/x_pin.txt ] || cat <<'EOF' > .auto/social/x_pin.txt
Starter Kit → {GUMROAD_BUNDLE_URL}
$99 Discovery → {PAY_LINK}
EOF
          [ -f .auto/social/linkedin_pin.txt ] || cat <<'EOF' > .auto/social/linkedin_pin.txt
I help teams stand up SDVOSB-grade automation & compliance without the chaos.
Starter Kit → {GUMROAD_BUNDLE_URL}
$99 Discovery → {PAY_LINK}
EOF
          # always create a tiny change so a PR is opened
          date -u +"%Y-%m-%dT%H:%M:%SZ" > .auto/social/.build_stamp
          ls -la .auto/social

      - name: Commit & open PR with rendered posts
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: add rendered social copy from sync run ${{ github.run_id }}"
          branch: automation/gumroad-social-${{ github.run_id }}
          title: "Rendered social copy from Gumroad Sync (${{ github.run_id }})"
          body: |
            This PR adds ready-to-paste pinned posts (generated by the workflow):
            - `.auto/social/x_pin.txt`
            - `.auto/social/linkedin_pin.txt`

            Copy/paste to X & LinkedIn (pin), then merge.
          add-paths: |
            .auto/social/**
