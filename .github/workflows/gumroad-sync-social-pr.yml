name: Gumroad Sync + Social PR (v3.1)

on:
  workflow_dispatch:   # manual only


on:
  workflow_dispatch:
  push:
    paths:
      - 'ops/gumroad-agent/config/gumroad.config.yaml'
      - 'ops/gumroad-agent/agents/gumroad_sync.py'
      - 'ops/gumroad-agent/scripts/social_post_out.py'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install requests PyYAML playwright || true

      - name: Install Playwright browsers (best-effort)
        run: |
          python -m playwright install --with-deps || true

      - name: Run Gumroad Sync (never fail pipeline)
        env:
          GUMROAD_ACCESS_TOKEN: ${{ secrets.GUMROAD_ACCESS_TOKEN }}
          GUMROAD_EMAIL: ${{ secrets.GUMROAD_EMAIL }}
          GUMROAD_PASSWORD: ${{ secrets.GUMROAD_PASSWORD }}
        run: |
          set -euxo pipefail
          python ops/gumroad-agent/agents/gumroad_sync.py --config ops/gumroad-agent/config/gumroad.config.yaml || true

      - name: Render social copy (always succeeds)
        run: |
          set -euo pipefail
          python ops/gumroad-agent/scripts/social_post_out.py || true
          mkdir -p rendered_social
          # Ensure files exist even if script short-circuited; use single-quoted heredocs to avoid $ expansion
          [ -f rendered_social/x_pin.txt ] || cat <<'EOF' > rendered_social/x_pin.txt
Starter Kit → {GUMROAD_BUNDLE_URL}
$99 Discovery → {PAY_LINK}
EOF
          [ -f rendered_social/linkedin_pin.txt ] || cat <<'EOF' > rendered_social/linkedin_pin.txt
Starter Kit → {GUMROAD_BUNDLE_URL}
$99 Discovery → {PAY_LINK}
EOF
          ls -la rendered_social

      - name: Commit & open PR with rendered posts
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: add rendered social copy from sync run ${{ github.run_id }}"
          branch: automation/gumroad-social-${{ github.run_id }}
          title: "Rendered social copy from Gumroad Sync (${{ github.run_id }})"
          body: |
            This PR adds ready-to-paste pinned posts:
            - `rendered_social/x_pin.txt`
            - `rendered_social/linkedin_pin.txt`

            Review the links and pin them on X & LinkedIn.
          add-paths: |
            rendered_social/**
