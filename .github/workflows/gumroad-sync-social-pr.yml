name: Gumroad Sync + Social PR (v3.1)

on:
  workflow_dispatch:
  push:
    paths:
      - 'ops/gumroad-agent/config/gumroad.config.yaml'
      - 'ops/gumroad-agent/agents/gumroad_sync.py'
      - 'ops/gumroad-agent/scripts/social_post_out.py'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install requests PyYAML playwright || true

      - name: Install Playwright browsers (best-effort)
        run: |
          python -m playwright install --with-deps || true

      - name: Run Gumroad Sync (never fail pipeline)
        env:
          GUMROAD_ACCESS_TOKEN: ${{ secrets.GUMROAD_ACCESS_TOKEN }}
          GUMROAD_EMAIL: ${{ secrets.GUMROAD_EMAIL }}
          GUMROAD_PASSWORD: ${{ secrets.GUMROAD_PASSWORD }}
        run: |
          set -euxo pipefail
          python ops/gumroad-agent/agents/gumroad_sync.py --config ops/gumroad-agent/config/gumroad.config.yaml || true

      - name: Render social copy (always succeeds)
        run: |
          set -euxo pipefail
          python ops/gumroad-agent/scripts/social_post_out.py || true
          mkdir -p rendered_social
          # ensure files exist even if script short-circuited
          [ -f rendered_social/x_pin.txt ] || echo "Starter Kit → {GUMROAD_BUNDLE_URL}\n$99 Discovery → {PAY_LINK}" > rendered_social/x_pin.txt
          [ -f rendered_social/linkedin_pin.txt ] || echo "Starter Kit → {GUMROAD_BUNDLE_URL}\n$99 Discovery → {PAY_LINK}" > rendered_social/linkedin_pin.txt
          ls -la rendered_social

      - name: Create branch for social artifacts
        run: |
          set -euxo pipefail
          BRANCH="automation/gumroad-social-${{ github.run_id }}"
          git checkout -b "$BRANCH"
          git add -A rendered_social
          git -c user.name='github-actions[bot]' -c user.email='41898282+github-actions[bot]@users.noreply.github.com' commit -m "chore: add rendered social copy from sync run ${{ github.run_id }}" || echo "No changes to commit."
          git push --set-upstream origin "$BRANCH" || echo "Branch push skipped (maybe no changes)."

      - name: Open PR with rendered posts
        uses: actions/github-script@v7
        with:
          script: |
            const runId = process.env.GITHUB_RUN_ID;
            const branch = `automation/gumroad-social-${runId}`;
            const { repo, owner } = context.repo;
            const title = `Rendered social copy from Gumroad Sync (${runId})`;
            const body = [
              "This PR adds ready-to-paste pinned posts:",
              "- `rendered_social/x_pin.txt`",
              "- `rendered_social/linkedin_pin.txt`",
              "",
              "Review the links and pin them on X & LinkedIn."
            ].join("\\n");
            try {
              await github.rest.pulls.create({ owner, repo, title, head: branch, base: "main", body });
            } catch (e) {
              core.warning(`PR creation skipped: ${e.message}`);
            }
